<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>State Space Models in Stan</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="Documentation for State Space Models in Stan.">
  <meta name="generator" content="bookdown 0.1 and GitBook 2.6.7">

  <meta property="og:title" content="State Space Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Documentation for State Space Models in Stan." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="State Space Models in Stan" />
  
  <meta name="twitter:description" content="Documentation for State Space Models in Stan." />
  

<meta name="author" content="Jeffrey B. Arnold">

<meta name="date" content="2016-07-16">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="example-models.html">
<link rel="next" href="stan-functions.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>

$$
\DeclareMathOperator{\E}{E}
\DeclareMathOperator{\mean}{mean}
\DeclareMathOperator{\Var}{Var}
\DeclareMathOperator{\Cov}{Cov}
\DeclareMathOperator{\Cor}{Cor}
\DeclareMathOperator{\Bias}{Bias}
\DeclareMathOperator{\MSE}{MSE}
\DeclareMathOperator{\sd}{sd}
\DeclareMathOperator{\se}{se}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\VEC}{vec}

\newcommand{\mat}[1]{\boldsymbol{#1}}
\newcommand{\vec}[1]{\boldsymbol{#1}}
\newcommand{\T}{'}

\newcommand{\distr}[1]{\mathcal{#1}}
\newcommand{\dnorm}{\distr{N}}
\newcommand{\dmvnorm}[1]{\distr{N}_{#1}}
\newcommand{\dt}[1]{\distr{T}_{#1}}

\newcommand{\cia}{\perp\!\!\!\perp}
\DeclareMathOperator*{\plim}{plim}
$$

  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">State Space Models in Stan</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="the-linear-state-space-model.html"><a href="the-linear-state-space-model.html"><i class="fa fa-check"></i><b>2</b> The Linear State Space Model</a></li>
<li class="chapter" data-level="3" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html"><i class="fa fa-check"></i><b>3</b> Filtering and Smoothing</a><ul>
<li class="chapter" data-level="3.1" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#filtering"><i class="fa fa-check"></i><b>3.1</b> Filtering</a></li>
<li class="chapter" data-level="3.2" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#smoothing"><i class="fa fa-check"></i><b>3.2</b> Smoothing</a><ul>
<li class="chapter" data-level="3.2.1" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#state-smoothing"><i class="fa fa-check"></i><b>3.2.1</b> State Smoothing</a></li>
<li class="chapter" data-level="3.2.2" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#disturbance-smoothing"><i class="fa fa-check"></i><b>3.2.2</b> Disturbance smoothing</a></li>
<li class="chapter" data-level="3.2.3" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#fast-state-smoothing"><i class="fa fa-check"></i><b>3.2.3</b> Fast state smoothing</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#simulation-smoothers"><i class="fa fa-check"></i><b>3.3</b> Simulation smoothers</a><ul>
<li class="chapter" data-level="3.3.1" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#mean-correction-simulation-smoother"><i class="fa fa-check"></i><b>3.3.1</b> Mean correction simulation smoother</a></li>
<li class="chapter" data-level="3.3.2" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#de-jong-shephard-method"><i class="fa fa-check"></i><b>3.3.2</b> de Jong-Shephard method</a></li>
<li class="chapter" data-level="3.3.3" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#forward-filter-backwards-smoother-ffbs"><i class="fa fa-check"></i><b>3.3.3</b> Forward-filter backwards-smoother (FFBS)</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#missing-observations"><i class="fa fa-check"></i><b>3.4</b> Missing observations</a></li>
<li class="chapter" data-level="3.5" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#forecasting-matrices"><i class="fa fa-check"></i><b>3.5</b> Forecasting matrices</a></li>
<li class="chapter" data-level="3.6" data-path="filtering-and-smoothing.html"><a href="filtering-and-smoothing.html#univariate-representation-of-multivariate-series"><i class="fa fa-check"></i><b>3.6</b> Univariate Representation of Multivariate Series</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="parameter-estimation.html"><a href="parameter-estimation.html"><i class="fa fa-check"></i><b>4</b> Parameter Estimation</a><ul>
<li class="chapter" data-level="4.1" data-path="parameter-estimation.html"><a href="parameter-estimation.html#log-log-likelihood"><i class="fa fa-check"></i><b>4.1</b> Log log-likelihood</a></li>
<li class="chapter" data-level="4.2" data-path="parameter-estimation.html"><a href="parameter-estimation.html#integrated-sampler"><i class="fa fa-check"></i><b>4.2</b> Integrated Sampler</a></li>
<li class="chapter" data-level="4.3" data-path="parameter-estimation.html"><a href="parameter-estimation.html#diagnostic-checking"><i class="fa fa-check"></i><b>4.3</b> Diagnostic Checking</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="example-models.html"><a href="example-models.html"><i class="fa fa-check"></i><b>5</b> Example Models</a></li>
<li class="chapter" data-level="6" data-path="example-models-1.html"><a href="example-models-1.html"><i class="fa fa-check"></i><b>6</b> Example Models</a><ul>
<li class="chapter" data-level="6.1" data-path="example-models-1.html"><a href="example-models-1.html#nile"><i class="fa fa-check"></i><b>6.1</b> Nile</a><ul>
<li class="chapter" data-level="6.1.1" data-path="example-models-1.html"><a href="example-models-1.html#local-level-model"><i class="fa fa-check"></i><b>6.1.1</b> Local Level Model</a></li>
<li class="chapter" data-level="6.1.2" data-path="example-models-1.html"><a href="example-models-1.html#local-level-with-known-intervention-intercept"><i class="fa fa-check"></i><b>6.1.2</b> Local level with known intervention (intercept)</a></li>
<li class="chapter" data-level="6.1.3" data-path="example-models-1.html"><a href="example-models-1.html#local-level-with-known-intervention-variance"><i class="fa fa-check"></i><b>6.1.3</b> Local Level with known intervention (variance)</a></li>
<li class="chapter" data-level="6.1.4" data-path="example-models-1.html"><a href="example-models-1.html#local-level-model-with-sparse-state-disturbances"><i class="fa fa-check"></i><b>6.1.4</b> Local Level model with Sparse State Disturbances</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="example-models-1.html"><a href="example-models-1.html#capm"><i class="fa fa-check"></i><b>6.2</b> CAPM</a></li>
<li class="chapter" data-level="6.3" data-path="example-models-1.html"><a href="example-models-1.html#australian-election-polling"><i class="fa fa-check"></i><b>6.3</b> Australian Election Polling</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="stan-functions.html"><a href="stan-functions.html"><i class="fa fa-check"></i><b>7</b> Stan Functions</a><ul>
<li class="chapter" data-level="7.1" data-path="stan-functions.html"><a href="stan-functions.html#utility-functions"><i class="fa fa-check"></i><b>7.1</b> Utility Functions</a><ul>
<li class="chapter" data-level="7.1.1" data-path="stan-functions.html"><a href="stan-functions.html#to_symmetric_matrix"><i class="fa fa-check"></i><b>7.1.1</b> to_symmetric_matrix</a></li>
<li class="chapter" data-level="7.1.2" data-path="stan-functions.html"><a href="stan-functions.html#to_matrix_colwise"><i class="fa fa-check"></i><b>7.1.2</b> to_matrix_colwise</a></li>
<li class="chapter" data-level="7.1.3" data-path="stan-functions.html"><a href="stan-functions.html#matrix_pow"><i class="fa fa-check"></i><b>7.1.3</b> matrix_pow</a></li>
<li class="chapter" data-level="7.1.4" data-path="stan-functions.html"><a href="stan-functions.html#symmat_size"><i class="fa fa-check"></i><b>7.1.4</b> symmat_size</a></li>
<li class="chapter" data-level="7.1.5" data-path="stan-functions.html"><a href="stan-functions.html#find_symmat_dim"><i class="fa fa-check"></i><b>7.1.5</b> find_symmat_dim</a></li>
<li class="chapter" data-level="7.1.6" data-path="stan-functions.html"><a href="stan-functions.html#vector_to_symmat"><i class="fa fa-check"></i><b>7.1.6</b> vector_to_symmat</a></li>
<li class="chapter" data-level="7.1.7" data-path="stan-functions.html"><a href="stan-functions.html#symmat_to_vector"><i class="fa fa-check"></i><b>7.1.7</b> symmat_to_vector</a></li>
<li class="chapter" data-level="7.1.8" data-path="stan-functions.html"><a href="stan-functions.html#rep_lower_triangular_matrix"><i class="fa fa-check"></i><b>7.1.8</b> rep_lower_triangular_matrix</a></li>
<li class="chapter" data-level="7.1.9" data-path="stan-functions.html"><a href="stan-functions.html#rep_upper_triangular_matrix"><i class="fa fa-check"></i><b>7.1.9</b> rep_upper_triangular_matrix</a></li>
<li class="chapter" data-level="7.1.10" data-path="stan-functions.html"><a href="stan-functions.html#rep_diagonal_triangular_matrix"><i class="fa fa-check"></i><b>7.1.10</b> rep_diagonal_triangular_matrix</a></li>
<li class="chapter" data-level="7.1.11" data-path="stan-functions.html"><a href="stan-functions.html#fill_matrix"><i class="fa fa-check"></i><b>7.1.11</b> fill_matrix</a></li>
<li class="chapter" data-level="7.1.12" data-path="stan-functions.html"><a href="stan-functions.html#fill_vector"><i class="fa fa-check"></i><b>7.1.12</b> fill_vector</a></li>
<li class="chapter" data-level="7.1.13" data-path="stan-functions.html"><a href="stan-functions.html#sum_int_true"><i class="fa fa-check"></i><b>7.1.13</b> sum_int_true</a></li>
<li class="chapter" data-level="7.1.14" data-path="stan-functions.html"><a href="stan-functions.html#sum_int_false"><i class="fa fa-check"></i><b>7.1.14</b> sum_int_false</a></li>
<li class="chapter" data-level="7.1.15" data-path="stan-functions.html"><a href="stan-functions.html#mask_indexes"><i class="fa fa-check"></i><b>7.1.15</b> mask_indexes</a></li>
<li class="chapter" data-level="7.1.16" data-path="stan-functions.html"><a href="stan-functions.html#select_indexes"><i class="fa fa-check"></i><b>7.1.16</b> select_indexes</a></li>
<li class="chapter" data-level="7.1.17" data-path="stan-functions.html"><a href="stan-functions.html#normal2_rng"><i class="fa fa-check"></i><b>7.1.17</b> normal2_rng</a></li>
<li class="chapter" data-level="7.1.18" data-path="stan-functions.html"><a href="stan-functions.html#choleksky_decompose2"><i class="fa fa-check"></i><b>7.1.18</b> choleksky_decompose2</a></li>
<li class="chapter" data-level="7.1.19" data-path="stan-functions.html"><a href="stan-functions.html#multi_normal2_rng"><i class="fa fa-check"></i><b>7.1.19</b> multi_normal2_rng</a></li>
<li class="chapter" data-level="7.1.20" data-path="stan-functions.html"><a href="stan-functions.html#multi_normal_cholesky2_rng"><i class="fa fa-check"></i><b>7.1.20</b> multi_normal_cholesky2_rng</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="stan-functions.html"><a href="stan-functions.html#filtering-1"><i class="fa fa-check"></i><b>7.2</b> Filtering</a><ul>
<li class="chapter" data-level="7.2.1" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_a"><i class="fa fa-check"></i><b>7.2.1</b> ssm_update_a</a></li>
<li class="chapter" data-level="7.2.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_p"><i class="fa fa-check"></i><b>7.2.2</b> ssm_update_P</a></li>
<li class="chapter" data-level="7.2.3" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_v"><i class="fa fa-check"></i><b>7.2.3</b> ssm_update_v</a></li>
<li class="chapter" data-level="7.2.4" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_v_u"><i class="fa fa-check"></i><b>7.2.4</b> ssm_update_v_u</a></li>
<li class="chapter" data-level="7.2.5" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_v_miss"><i class="fa fa-check"></i><b>7.2.5</b> ssm_update_v_miss</a></li>
<li class="chapter" data-level="7.2.6" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_f"><i class="fa fa-check"></i><b>7.2.6</b> ssm_update_F</a></li>
<li class="chapter" data-level="7.2.7" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_finv"><i class="fa fa-check"></i><b>7.2.7</b> ssm_update_Finv</a></li>
<li class="chapter" data-level="7.2.8" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_f_u"><i class="fa fa-check"></i><b>7.2.8</b> ssm_update_F_u</a></li>
<li class="chapter" data-level="7.2.9" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_finv_u"><i class="fa fa-check"></i><b>7.2.9</b> ssm_update_Finv_u</a></li>
<li class="chapter" data-level="7.2.10" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_finv_miss"><i class="fa fa-check"></i><b>7.2.10</b> ssm_update_Finv_miss</a></li>
<li class="chapter" data-level="7.2.11" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_k"><i class="fa fa-check"></i><b>7.2.11</b> ssm_update_K</a></li>
<li class="chapter" data-level="7.2.12" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_k_u"><i class="fa fa-check"></i><b>7.2.12</b> ssm_update_K_u</a></li>
<li class="chapter" data-level="7.2.13" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_l"><i class="fa fa-check"></i><b>7.2.13</b> ssm_update_L</a></li>
<li class="chapter" data-level="7.2.14" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_loglik"><i class="fa fa-check"></i><b>7.2.14</b> ssm_update_loglik</a></li>
<li class="chapter" data-level="7.2.15" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_loglik_miss"><i class="fa fa-check"></i><b>7.2.15</b> ssm_update_loglik_miss</a></li>
<li class="chapter" data-level="7.2.16" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_loglik_u"><i class="fa fa-check"></i><b>7.2.16</b> ssm_update_loglik_u</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="stan-functions.html"><a href="stan-functions.html#filtering-2"><i class="fa fa-check"></i><b>7.3</b> Filtering</a><ul>
<li class="chapter" data-level="7.3.1" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_idx"><i class="fa fa-check"></i><b>7.3.1</b> ssm_filter_idx</a></li>
<li class="chapter" data-level="7.3.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_size"><i class="fa fa-check"></i><b>7.3.2</b> ssm_filter_size</a></li>
<li class="chapter" data-level="7.3.3" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_get_loglik"><i class="fa fa-check"></i><b>7.3.3</b> ssm_filter_get_loglik</a></li>
<li class="chapter" data-level="7.3.4" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_get_v"><i class="fa fa-check"></i><b>7.3.4</b> ssm_filter_get_v</a></li>
<li class="chapter" data-level="7.3.5" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_get_finv"><i class="fa fa-check"></i><b>7.3.5</b> ssm_filter_get_Finv</a></li>
<li class="chapter" data-level="7.3.6" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_get_k"><i class="fa fa-check"></i><b>7.3.6</b> ssm_filter_get_K</a></li>
<li class="chapter" data-level="7.3.7" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_get_a"><i class="fa fa-check"></i><b>7.3.7</b> ssm_filter_get_a</a></li>
<li class="chapter" data-level="7.3.8" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_get_p"><i class="fa fa-check"></i><b>7.3.8</b> ssm_filter_get_P</a></li>
<li class="chapter" data-level="7.3.9" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter"><i class="fa fa-check"></i><b>7.3.9</b> ssm_filter</a></li>
<li class="chapter" data-level="7.3.10" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_miss"><i class="fa fa-check"></i><b>7.3.10</b> ssm_filter_miss</a></li>
<li class="chapter" data-level="7.3.11" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_states"><i class="fa fa-check"></i><b>7.3.11</b> ssm_filter_states</a></li>
<li class="chapter" data-level="7.3.12" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_states_get_a"><i class="fa fa-check"></i><b>7.3.12</b> ssm_filter_states_get_a</a></li>
<li class="chapter" data-level="7.3.13" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_states_get_p"><i class="fa fa-check"></i><b>7.3.13</b> ssm_filter_states_get_P</a></li>
<li class="chapter" data-level="7.3.14" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_states_update_a"><i class="fa fa-check"></i><b>7.3.14</b> ssm_filter_states_update_a</a></li>
<li class="chapter" data-level="7.3.15" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_states_update_p"><i class="fa fa-check"></i><b>7.3.15</b> ssm_filter_states_update_P</a></li>
<li class="chapter" data-level="7.3.16" data-path="stan-functions.html"><a href="stan-functions.html#ssm_filter_states-1"><i class="fa fa-check"></i><b>7.3.16</b> ssm_filter_states</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="stan-functions.html"><a href="stan-functions.html#log-likelihood"><i class="fa fa-check"></i><b>7.4</b> Log-likelihood</a><ul>
<li class="chapter" data-level="7.4.1" data-path="stan-functions.html"><a href="stan-functions.html#ssm_lpdf"><i class="fa fa-check"></i><b>7.4.1</b> ssm_lpdf</a></li>
<li class="chapter" data-level="7.4.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_miss_lpdf"><i class="fa fa-check"></i><b>7.4.2</b> ssm_miss_lpdf</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="stan-functions.html"><a href="stan-functions.html#time-invariant-kalman-filter"><i class="fa fa-check"></i><b>7.5</b> Time-Invariant Kalman Filter</a><ul>
<li class="chapter" data-level="7.5.1" data-path="stan-functions.html"><a href="stan-functions.html#matrix_diff"><i class="fa fa-check"></i><b>7.5.1</b> matrix_diff</a></li>
<li class="chapter" data-level="7.5.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_constant_lpdf"><i class="fa fa-check"></i><b>7.5.2</b> ssm_constant_lpdf</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="stan-functions.html"><a href="stan-functions.html#common-smoother-functions"><i class="fa fa-check"></i><b>7.6</b> Common Smoother Functions</a><ul>
<li class="chapter" data-level="7.6.1" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_r"><i class="fa fa-check"></i><b>7.6.1</b> ssm_update_r</a></li>
<li class="chapter" data-level="7.6.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_update_n"><i class="fa fa-check"></i><b>7.6.2</b> ssm_update_N</a></li>
<li class="chapter" data-level="7.6.3" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_state_size"><i class="fa fa-check"></i><b>7.6.3</b> ssm_smooth_state_size</a></li>
<li class="chapter" data-level="7.6.4" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_state_get_mean"><i class="fa fa-check"></i><b>7.6.4</b> ssm_smooth_state_get_mean</a></li>
<li class="chapter" data-level="7.6.5" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_state_get_var"><i class="fa fa-check"></i><b>7.6.5</b> ssm_smooth_state_get_var</a></li>
<li class="chapter" data-level="7.6.6" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_state"><i class="fa fa-check"></i><b>7.6.6</b> ssm_smooth_state</a></li>
<li class="chapter" data-level="7.6.7" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eps_size"><i class="fa fa-check"></i><b>7.6.7</b> ssm_smooth_eps_size</a></li>
<li class="chapter" data-level="7.6.8" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eps_get_mean"><i class="fa fa-check"></i><b>7.6.8</b> ssm_smooth_eps_get_mean</a></li>
<li class="chapter" data-level="7.6.9" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eps_get_var"><i class="fa fa-check"></i><b>7.6.9</b> ssm_smooth_eps_get_var</a></li>
<li class="chapter" data-level="7.6.10" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eps"><i class="fa fa-check"></i><b>7.6.10</b> ssm_smooth_eps</a></li>
<li class="chapter" data-level="7.6.11" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eta"><i class="fa fa-check"></i><b>7.6.11</b> ssm_smooth_eta</a></li>
<li class="chapter" data-level="7.6.12" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eta_get_mean"><i class="fa fa-check"></i><b>7.6.12</b> ssm_smooth_eta_get_mean</a></li>
<li class="chapter" data-level="7.6.13" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eta_get_var"><i class="fa fa-check"></i><b>7.6.13</b> ssm_smooth_eta_get_var</a></li>
<li class="chapter" data-level="7.6.14" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_eta-1"><i class="fa fa-check"></i><b>7.6.14</b> ssm_smooth_eta</a></li>
<li class="chapter" data-level="7.6.15" data-path="stan-functions.html"><a href="stan-functions.html#ssm_smooth_state_mean"><i class="fa fa-check"></i><b>7.6.15</b> ssm_smooth_state_mean</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="stan-functions.html"><a href="stan-functions.html#simulators-and-smoothing-simulators"><i class="fa fa-check"></i><b>7.7</b> Simulators and Smoothing Simulators</a><ul>
<li class="chapter" data-level="7.7.1" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_idx"><i class="fa fa-check"></i><b>7.7.1</b> ssm_sim_idx</a></li>
<li class="chapter" data-level="7.7.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_size"><i class="fa fa-check"></i><b>7.7.2</b> ssm_sim_size</a></li>
<li class="chapter" data-level="7.7.3" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_get_y"><i class="fa fa-check"></i><b>7.7.3</b> ssm_sim_get_y</a></li>
<li class="chapter" data-level="7.7.4" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_get_a"><i class="fa fa-check"></i><b>7.7.4</b> ssm_sim_get_a</a></li>
<li class="chapter" data-level="7.7.5" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_get_eps"><i class="fa fa-check"></i><b>7.7.5</b> ssm_sim_get_eps</a></li>
<li class="chapter" data-level="7.7.6" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_get_eta"><i class="fa fa-check"></i><b>7.7.6</b> ssm_sim_get_eta</a></li>
<li class="chapter" data-level="7.7.7" data-path="stan-functions.html"><a href="stan-functions.html#ssm_sim_rng"><i class="fa fa-check"></i><b>7.7.7</b> ssm_sim_rng</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="stan-functions.html"><a href="stan-functions.html#simulation-smoothers-1"><i class="fa fa-check"></i><b>7.8</b> Simulation Smoothers</a><ul>
<li class="chapter" data-level="7.8.1" data-path="stan-functions.html"><a href="stan-functions.html#ssm_simsmo_state_rng"><i class="fa fa-check"></i><b>7.8.1</b> ssm_simsmo_state_rng</a></li>
<li class="chapter" data-level="7.8.2" data-path="stan-functions.html"><a href="stan-functions.html#ssm_simsmo_eta_rng"><i class="fa fa-check"></i><b>7.8.2</b> ssm_simsmo_eta_rng</a></li>
<li class="chapter" data-level="7.8.3" data-path="stan-functions.html"><a href="stan-functions.html#ssm_simsmo_eps_rng"><i class="fa fa-check"></i><b>7.8.3</b> ssm_simsmo_eps_rng</a></li>
</ul></li>
<li class="chapter" data-level="7.9" data-path="stan-functions.html"><a href="stan-functions.html#stationary"><i class="fa fa-check"></i><b>7.9</b> Stationary</a><ul>
<li class="chapter" data-level="7.9.1" data-path="stan-functions.html"><a href="stan-functions.html#pacf_to_acf"><i class="fa fa-check"></i><b>7.9.1</b> pacf_to_acf</a></li>
<li class="chapter" data-level="7.9.2" data-path="stan-functions.html"><a href="stan-functions.html#constrain_stationary"><i class="fa fa-check"></i><b>7.9.2</b> constrain_stationary</a></li>
<li class="chapter" data-level="7.9.3" data-path="stan-functions.html"><a href="stan-functions.html#acf_to_pacf"><i class="fa fa-check"></i><b>7.9.3</b> acf_to_pacf</a></li>
<li class="chapter" data-level="7.9.4" data-path="stan-functions.html"><a href="stan-functions.html#unconstrain_stationary"><i class="fa fa-check"></i><b>7.9.4</b> unconstrain_stationary</a></li>
<li class="chapter" data-level="7.9.5" data-path="stan-functions.html"><a href="stan-functions.html#kronecker_prod"><i class="fa fa-check"></i><b>7.9.5</b> kronecker_prod</a></li>
<li class="chapter" data-level="7.9.6" data-path="stan-functions.html"><a href="stan-functions.html#ssm_stationary_cov"><i class="fa fa-check"></i><b>7.9.6</b> ssm_stationary_cov</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="other-software.html"><a href="other-software.html"><i class="fa fa-check"></i><b>8</b> Other Software</a><ul>
<li class="chapter" data-level="8.1" data-path="other-software.html"><a href="other-software.html#r-packages"><i class="fa fa-check"></i><b>8.1</b> R packages</a></li>
<li class="chapter" data-level="8.2" data-path="other-software.html"><a href="other-software.html#other"><i class="fa fa-check"></i><b>8.2</b> Other</a><ul>
<li class="chapter" data-level="8.2.1" data-path="other-software.html"><a href="other-software.html#stata"><i class="fa fa-check"></i><b>8.2.1</b> Stata</a></li>
<li class="chapter" data-level="8.2.2" data-path="other-software.html"><a href="other-software.html#python"><i class="fa fa-check"></i><b>8.2.2</b> Python</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">State Space Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="example-models-1" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Example Models</h1>
<div id="nile" class="section level2">
<h2><span class="header-section-number">6.1</span> Nile</h2>
<p>This is a short (<span class="math inline">\(n = 100\)</span>) univariate time series of the annual flow volumes of the Nile River at Aswan between 1871 and 1970. This series is described in <span class="citation">Durbin and Koopman (<a href="#ref-DurbinKoopman2012">2012</a>)</span> and had been analyzed by <span class="citation">Cobb (<a href="#ref-Cobb1978">1978</a>)</span> and <span class="citation">Balke (<a href="#ref-Balke1993">1993</a>)</span>, and in numerous time series textbooks. A notable feature of the series is a seeming structural break in 1899, around the time of the completion of the Aswan dam.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;Nile&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;datasets&quot;</span>)
Nile_ &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">year =</span> <span class="kw">year</span>(<span class="kw">as.Date</span>(Nile)),
                    <span class="dt">flow =</span> <span class="kw">as.numeric</span>(Nile),
                    <span class="dt">obs =</span> <span class="kw">seq_along</span>(Nile))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(Nile_, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> flow)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Annual Flow&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="example-Nile_files/figure-html/Nile_plot-1.png" width="672" /></p>
<div id="local-level-model" class="section level3">
<h3><span class="header-section-number">6.1.1</span> Local Level Model</h3>
<p>The Nile data can be modeled as a local level model, <span class="math display">\[
\begin{aligned}[t]
y_t &amp;= \mu_t + \varepsilon_t &amp; \varepsilon_t &amp; \sim N(0, \sigma_{\varepsilon}^2) \\
\mu_{t + 1} &amp;= \mu_t + \eta_t &amp;
\eta_t &amp; \sim N(0, \sigma^2_{\eta})
\end{aligned}
\]</span></p>
<pre><code>functions {
  #include ssm.stan
}
data {
  int&lt;lower = 1&gt; n;
  vector[1] y[n];
  vector&lt;lower = 0.0&gt;[1] a1;
  cov_matrix[1] P1;
  real&lt;lower = 0.0&gt; y_scale;
}
transformed data {
  // system matrices
  matrix[1, 1] T;
  matrix[1, 1] Z;
  matrix[1, 1] R;
  vector[1] c;
  vector[1] d;
  int m;
  int p;
  int q;
  int filter_sz;
  m = 1;
  p = 1;
  q = 1;
  T[1, 1] = 1.0;
  Z[1, 1] = 1.0;
  R[1, 1] = 1.0;
  c[1] = 0.0;
  d[1] = 0.0;
  filter_sz = ssm_filter_size(m, p);
}
parameters {
  real&lt;lower = 0.0&gt; sigma_eta;
  real&lt;lower = 0.0&gt; sigma_epsilon;
}
transformed parameters {
  matrix[1, 1] H;
  matrix[1, 1] Q;
  H[1, 1] = pow(sigma_epsilon, 2);
  Q[1, 1] = pow(sigma_eta * sigma_epsilon, 2);
}
model {
  y ~ ssm_constant_lpdf(d, Z, H, c, T, R, Q, a1, P1);
  sigma_epsilon ~ cauchy(0.0, y_scale);
  sigma_eta ~ cauchy(0.0, 1.0);
}
generated quantities {
  vector[filter_sz] filtered[n];
  vector[1] alpha[n];
  vector[1] eta[n];
  vector[1] eps[n];
  // filtering
  filtered = ssm_filter(y,
    rep_array(d, 1),
    rep_array(Z, 1),
    rep_array(H, 1),
    rep_array(c, 1),
    rep_array(T, 1),
    rep_array(R, 1),
    rep_array(Q, 1), a1, P1);
  // sampling states
  alpha = ssm_simsmo_states_rng(filtered,
    rep_array(d, 1),
    rep_array(Z, 1),
    rep_array(H, 1),
    rep_array(c, 1),
    rep_array(T, 1),
    rep_array(R, 1),
    rep_array(Q, 1), a1, P1);
  eps = ssm_simsmo_eps_rng(filtered,
    rep_array(d, 1),
    rep_array(Z, 1),
    rep_array(H, 1),
    rep_array(c, 1),
    rep_array(T, 1),
    rep_array(R, 1),
    rep_array(Q, 1), a1, P1);
  eta = ssm_simsmo_eta_rng(filtered,
    rep_array(d, 1),
    rep_array(Z, 1),
    rep_array(H, 1),
    rep_array(c, 1),
    rep_array(T, 1),
    rep_array(R, 1),
    rep_array(Q, 1), a1, P1);
}</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">local_level_mod &lt;-<span class="st"> </span><span class="kw">ssm_stan_model</span>(<span class="st">&quot;local_level.stan&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_1_data &lt;-<span class="st"> </span><span class="kw">within</span>(<span class="kw">list</span>(), {
  y &lt;-<span class="st"> </span><span class="kw">matrix</span>(Nile_$flow)
  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(y)
  a1 &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dv">1</span>)
  P1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">10</span> ^<span class="st"> </span><span class="dv">7</span>)
  y_scale &lt;-<span class="st"> </span><span class="kw">sd</span>(Nile_$flow)
})
nile_1_samples &lt;-
<span class="st">  </span><span class="kw">sampling</span>(local_level_mod,
           <span class="dt">chains =</span> <span class="dv">1</span>,
           <span class="dt">iter =</span> <span class="dv">500</span>,
           <span class="dt">data =</span> nile_1_data)
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL &#39;local_level&#39; NOW (CHAIN 1).</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Chain 1, Iteration:   1 / 500 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration:  50 / 500 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 100 / 500 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 150 / 500 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 200 / 500 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 250 / 500 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 251 / 500 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 300 / 500 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 350 / 500 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 400 / 500 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 450 / 500 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 500 / 500 [100%]  (Sampling)</span>
<span class="co">#&gt;  Elapsed Time: 5.56571 seconds (Warm-up)</span>
<span class="co">#&gt;                5.32206 seconds (Sampling)</span>
<span class="co">#&gt;                10.8878 seconds (Total)</span></code></pre></div>
<p>Now, summarize the MCMC samples using the <code>summary</code> function on the <code>stanfit</code> object. Additionally, I use the <code>tidy_stan_summary</code> function to make the results of <code>summary</code> easier to work with. This converts the results of <code>summary</code> from a list of matrices to a list of data frames, and also parses the parameter names so that it is easier to select particular parameter values by name. I also will only use only the summary statistics for the combined chains.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_1_summary &lt;-<span class="st"> </span><span class="kw">tidy_stan_summary</span>(<span class="kw">summary</span>(nile_1_samples))[[<span class="st">&quot;all&quot;</span>]] %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(Nile_, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;dim_1&quot;</span> =<span class="st"> &quot;obs&quot;</span>))</code></pre></div>
<p>The estimated variances of the observation and state variances,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(nile_1_summary, parameter %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;H&quot;</span>, <span class="st">&quot;Q&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(parname, mean, se_mean, p2<span class="fl">.5</span>, p97<span class="fl">.5</span>, n_eff, Rhat)
<span class="co">#&gt; # A tibble: 2 x 7</span>
<span class="co">#&gt;   parname  mean se_mean  p2.5 p97.5 n_eff  Rhat</span>
<span class="co">#&gt;     &lt;chr&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1  H[1,1] 14096     350  8517 19898  77.7 0.996</span>
<span class="co">#&gt; 2  Q[1,1]  2502     233   425  6828  61.5 0.996</span></code></pre></div>
<p>are similar to the MLE estimates producted by <code>StructTS</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">StructTS</span>(Nile_$flow, <span class="dt">type =</span> <span class="st">&quot;level&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; StructTS(x = Nile_$flow, type = &quot;level&quot;)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Variances:</span>
<span class="co">#&gt;   level  epsilon  </span>
<span class="co">#&gt;    1469    15099</span></code></pre></div>
<p>However, since the Bayesian estimates are means, the MLE estimates are modes, and the posterior distribution of the variances are right skewed, the means are larger than the posterior modes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">str_keep &lt;-<span class="st"> </span>function(string, pattern) {
  string[<span class="kw">str_detect</span>(string, pattern)]
}

<span class="kw">ggplot</span>(<span class="kw">filter</span>(nile_1_summary, parameter ==<span class="st"> &quot;alpha&quot;</span>),
       <span class="kw">aes</span>(<span class="dt">x =</span> year,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> flow)) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Annual river flow&quot;</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Observation&quot;</span>) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-Nile_files/figure-html/nile_1_states-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">filter</span>(nile_1_summary, parameter ==<span class="st"> &quot;eta&quot;</span>),
       <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> mean,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>()</code></pre></div>
<p><img src="example-Nile_files/figure-html/nile_1_eta-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">filter</span>(nile_1_summary, parameter ==<span class="st"> &quot;eps&quot;</span>),
       <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> mean,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>()</code></pre></div>
<p><img src="example-Nile_files/figure-html/nile_1_eps-1.png" width="672" /></p>
<p><strong>TODO</strong> Diagnostics. What are the relevant Bayesian analogs?</p>
</div>
<div id="local-level-with-known-intervention-intercept" class="section level3">
<h3><span class="header-section-number">6.1.2</span> Local level with known intervention (intercept)</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_2_mod &lt;-<span class="st"> </span><span class="kw">ssm_stan_model</span>(<span class="st">&quot;local_level_reg.stan&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_2_data &lt;-<span class="st"> </span>nile_1_data
nile_2_data[[<span class="st">&quot;x&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">as.integer</span>(Nile_$year &gt;<span class="st"> </span><span class="dv">1899</span>))
nile_2_data[[<span class="st">&quot;k&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">ncol</span>(nile_2_data[[<span class="st">&quot;x&quot;</span>]])
nile_2_samples &lt;-<span class="st"> </span><span class="kw">sampling</span>(nile_2_mod, <span class="dt">chains =</span> <span class="dv">1</span>, <span class="dt">iter =</span> <span class="dv">500</span>,
                           <span class="dt">data =</span> nile_2_data)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_2_summary &lt;-<span class="st"> </span><span class="kw">tidy_stan_summary</span>(<span class="kw">summary</span>(nile_2_samples))[[<span class="st">&quot;all&quot;</span>]] %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(Nile_, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;dim_1&quot;</span> =<span class="st"> &quot;obs&quot;</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">filter</span>(nile_2_summary, parameter ==<span class="st"> &quot;mu&quot;</span>),
       <span class="kw">aes</span>(<span class="dt">x =</span> year,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> flow)) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Annual river flow&quot;</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Observation&quot;</span>) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-Nile_files/figure-html/nile_2_states-1.png" width="672" /></p>
</div>
<div id="local-level-with-known-intervention-variance" class="section level3">
<h3><span class="header-section-number">6.1.3</span> Local Level with known intervention (variance)</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_3_mod &lt;-<span class="st"> </span><span class="kw">ssm_stan_model</span>(<span class="st">&quot;local_level_interven.stan&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_3_data &lt;-<span class="st"> </span>nile_1_data
nile_3_data[[<span class="st">&quot;s&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">ifelse</span>(Nile_$year ==<span class="st"> </span><span class="dv">1899</span>, <span class="dv">10</span>, <span class="dv">1</span>)
nile_3_samples &lt;-<span class="st"> </span><span class="kw">sampling</span>(nile_3_mod, <span class="dt">chains =</span> <span class="dv">1</span>, <span class="dt">iter =</span> <span class="dv">500</span>,
                           <span class="dt">data =</span> nile_3_data)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_3_summary &lt;-<span class="st"> </span><span class="kw">tidy_stan_summary</span>(<span class="kw">summary</span>(nile_3_samples))[[<span class="st">&quot;all&quot;</span>]] %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(Nile_, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;dim_1&quot;</span> =<span class="st"> &quot;obs&quot;</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">filter</span>(nile_3_summary, parameter ==<span class="st"> &quot;alpha&quot;</span>),
       <span class="kw">aes</span>(<span class="dt">x =</span> year,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> flow)) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Annual river flow&quot;</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Observation&quot;</span>) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-Nile_files/figure-html/nile_3_states-1.png" width="672" /></p>
</div>
<div id="local-level-model-with-sparse-state-disturbances" class="section level3">
<h3><span class="header-section-number">6.1.4</span> Local Level model with Sparse State Disturbances</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_4_mod &lt;-<span class="st"> </span><span class="kw">ssm_stan_model</span>(<span class="st">&quot;local_level_tvvar.stan&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_4_data &lt;-<span class="st"> </span>nile_1_data
nile_4_data[[<span class="st">&quot;s&quot;</span>]] &lt;-<span class="st"> </span><span class="dv">1</span> /<span class="st"> </span><span class="kw">nrow</span>(Nile_)
nile_4_samples &lt;-<span class="st"> </span><span class="kw">sampling</span>(nile_4_mod, <span class="dt">chains =</span> <span class="dv">1</span>, <span class="dt">iter =</span> <span class="dv">500</span>,
                           <span class="dt">data =</span> nile_4_data)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nile_4_summary &lt;-<span class="st"> </span><span class="kw">tidy_stan_summary</span>(<span class="kw">summary</span>(nile_4_samples))[[<span class="st">&quot;all&quot;</span>]] %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(Nile_, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;dim_1&quot;</span> =<span class="st"> &quot;obs&quot;</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">filter</span>(nile_4_summary, parameter ==<span class="st"> &quot;alpha&quot;</span>),
       <span class="kw">aes</span>(<span class="dt">x =</span> year,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> flow)) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Annual river flow&quot;</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Observation&quot;</span>) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-Nile_files/figure-html/nile_4_states-1.png" width="672" /></p>

</div>
</div>
<div id="capm" class="section level2">
<h2><span class="header-section-number">6.2</span> CAPM</h2>
<p>This is a simplified example of CAPM model from <span class="citation">Petris (<a href="#ref-Petris2010a">2010</a>)</span>. A simplified capital-asset pricicing model (CAPM) model is a model of the excess return (return relative to a risk-free asset) of stocks. In this example, the excess return of a stock is proportional to the market return (return of a portfolio of stocks representing the whole market).</p>
<p>Let <span class="math inline">\(y_{j,t}\)</span> be the excess return of stock <span class="math inline">\(j\)</span> in period <span class="math inline">\(t\)</span>. The model that we will estimate is, <span class="math display">\[
\begin{aligned}[t]
\vec{y}_{j,t} &amp;= \beta_{j,t} x_t + \varepsilon_{j,t} &amp; \vec{\varepsilon}_t &amp; \sim N(\vec{0}, \mat{\Sigma}_{\varepsilon} \\
\beta_{j,t} &amp;= \beta_{j,t} + \eta_{j,t} &amp; \vec{\eta}_{t} &amp; \sim N(\vec{0}, \mat{\Sigma}_{\eta})
\end{aligned}
\]</span> The proportionality constants of the stocks are stock- and time-specific, with each <span class="math inline">\(\vec{\beta}_j\)</span> following a random walk.[^alpha] However, both the observation disturbances (<span class="math inline">\(\mat{\Sigma}_{\varepsilon}\)</span> and state disturbances (<span class="math inline">\(\mat{\Sigma}_{\eta}\)</span>) allow for correlation between the stocks. In the model estimated here, the intercepts for each stock are assumed to be zero.</p>
<p>The data, originally from <span class="citation">Berndt (<a href="#ref-Berndt1991a">1991</a>)</span>, are the monthly returns of four stocks (Mobil, IBM, Weyer, and Citicorp) from January 1978 to December 1987. The interest rate on 30-day Treasury Bill is used as the risk free rate (<code>rkfree</code>), and the value-weighted average returns of all stocks listed on the New York and American Stock Exchanges as the market return (<code>market</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;capm&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;StanStateSpace&quot;</span>)
<span class="kw">glimpse</span>(capm)
<span class="co">#&gt; Observations: 120</span>
<span class="co">#&gt; Variables: 7</span>
<span class="co">#&gt; $ date   &lt;date&gt; 1978-01-01, 1978-02-01, 1978-03-01, 1978-04-01, 1978-0...</span>
<span class="co">#&gt; $ mobil  &lt;dbl&gt; -0.046, -0.017, 0.049, 0.077, -0.011, -0.043, 0.028, 0....</span>
<span class="co">#&gt; $ ibm    &lt;dbl&gt; -0.029, -0.043, -0.063, 0.130, -0.018, -0.004, 0.092, 0...</span>
<span class="co">#&gt; $ weyer  &lt;dbl&gt; -0.116, -0.135, 0.084, 0.144, -0.031, 0.005, 0.164, 0.0...</span>
<span class="co">#&gt; $ citcrp &lt;dbl&gt; -0.115, -0.019, 0.059, 0.127, 0.005, 0.007, 0.032, 0.08...</span>
<span class="co">#&gt; $ market &lt;dbl&gt; -0.045, 0.010, 0.050, 0.063, 0.067, 0.007, 0.071, 0.079...</span>
<span class="co">#&gt; $ rkfree &lt;dbl&gt; 0.00487, 0.00494, 0.00526, 0.00491, 0.00513, 0.00527, 0...</span></code></pre></div>
<p>In the analysis, the excess returns (return minus risk-free return) are used. So, the first step is to subtract the risk-free returns (<code>rkfree</code>) from each of the stock return columns and the market return.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">capm &lt;-<span class="st"> </span>capm %&gt;%
<span class="st">  </span><span class="kw">mutate_each</span>(<span class="kw">funs</span>(. -<span class="st"> </span>rkfree), <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="st">&quot;mobil&quot;</span>, <span class="st">&quot;ibm&quot;</span>, <span class="st">&quot;weyer&quot;</span>, <span class="st">&quot;citcrp&quot;</span>,
                                         <span class="st">&quot;market&quot;</span>))) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">obs =</span> <span class="kw">row_number</span>())
<span class="kw">ggplot</span>(<span class="kw">gather</span>(<span class="kw">select</span>(capm, -rkfree), asset, rate, -date, -obs),
       <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> rate)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">facet_grid</span>(asset ~<span class="st"> </span>.) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-capm_files/figure-html/capm-data-clean-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">capm_mod &lt;-<span class="st"> </span><span class="kw">ssm_stan_model</span>(<span class="st">&quot;capm.stan&quot;</span>)

capm_data &lt;-
<span class="st">  </span><span class="kw">within</span>(<span class="kw">list</span>(), {
    y &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(capm[ , <span class="kw">c</span>(<span class="st">&quot;mobil&quot;</span>, <span class="st">&quot;ibm&quot;</span>, <span class="st">&quot;weyer&quot;</span>, <span class="st">&quot;citcrp&quot;</span>)])
    x &lt;-<span class="st"> </span>capm[[<span class="st">&quot;market&quot;</span>]]
    n &lt;-<span class="st"> </span><span class="kw">nrow</span>(capm)
    m &lt;-<span class="st"> </span><span class="kw">ncol</span>(y)
    y_scale &lt;-<span class="st"> </span><span class="kw">apply</span>(y, <span class="dv">2</span>, sd)
    a1 &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, m)
    P1 &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="fl">1e6</span>, m, m)
  })

capm_samples &lt;-<span class="st"> </span><span class="kw">sampling</span>(capm_mod, <span class="dt">chains =</span> <span class="dv">1</span>, <span class="dt">iter =</span> <span class="dv">1000</span>,
                         <span class="dt">data =</span> capm_data)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">capm_samples &lt;-<span class="st"> </span><span class="kw">tidy_stan_summary</span>(<span class="kw">summary</span>(capm_samples))[[<span class="st">&quot;all&quot;</span>]] %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">mutate</span>(capm, <span class="dt">obs =</span> <span class="kw">row_number</span>()) %&gt;%<span class="st"> </span><span class="kw">select</span>(date, obs),
            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;dim_1&quot;</span> =<span class="st"> &quot;obs&quot;</span>))

capm_betas &lt;-<span class="st"> </span><span class="kw">filter</span>(capm_samples, parameter ==<span class="st"> &quot;beta&quot;</span>) %&gt;%
<span class="st">         </span><span class="kw">mutate</span>(<span class="dt">stock =</span> <span class="kw">recode</span>(dim_2,
                                <span class="st">`</span><span class="dt">1</span><span class="st">`</span> =<span class="st"> &quot;mobil&quot;</span>,
                                <span class="st">`</span><span class="dt">2</span><span class="st">`</span> =<span class="st"> &quot;ibm&quot;</span>,
                                <span class="st">`</span><span class="dt">3</span><span class="st">`</span> =<span class="st"> &quot;weyer&quot;</span>,
                                <span class="st">`</span><span class="dt">4</span><span class="st">`</span> =<span class="st"> &quot;citcrp&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">gather</span>(capm, stock, rate, -market, -date, -obs),
            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;stock&quot;</span>))

<span class="kw">ggplot</span>(capm_betas,
       <span class="kw">aes</span>(<span class="dt">x =</span> date,
           <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
           <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd)) +
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean)) +
<span class="st">  </span><span class="kw">facet_grid</span>(stock ~<span class="st"> </span>.) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-capm_files/figure-html/capm-state-plot-1.png" width="672" /></p>
<p><strong>TODO</strong> Show estimated covariance matrices</p>

</div>
<div id="australian-election-polling" class="section level2">
<h2><span class="header-section-number">6.3</span> Australian Election Polling</h2>
<p>Example from Simon Jackmans textbook (Ex 9.3) and 2005 paper.</p>
<p>The data consist of 239 polls by the Australian pollsters (Newspoll, Nielsen, Morgan, and Galaxy) betwen the October 9, 2004, and November 24, 2007 Australian Federal elections.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;AustralianElectionPolling&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;pscl&quot;</span>)
<span class="kw">glimpse</span>(AustralianElectionPolling)
<span class="co">#&gt; Observations: 239</span>
<span class="co">#&gt; Variables: 14</span>
<span class="co">#&gt; $ ALP         &lt;dbl&gt; 39.5, 39.0, 38.0, 36.0, 33.0, 36.5, 39.0, 37.0, 34...</span>
<span class="co">#&gt; $ Lib         &lt;dbl&gt; 44.5, 44.0, 46.0, 46.5, 47.0, 45.5, 46.0, 47.0, 52...</span>
<span class="co">#&gt; $ Nat         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</span>
<span class="co">#&gt; $ Green       &lt;dbl&gt; 8.5, 8.5, 6.0, 9.0, 8.0, 9.5, 6.0, 7.5, 8.0, 7.0, ...</span>
<span class="co">#&gt; $ FamilyFirst &lt;dbl&gt; 2.0, 1.5, 0.0, 2.5, 0.0, 2.0, 0.0, 2.0, 0.0, 0.0, ...</span>
<span class="co">#&gt; $ Dems        &lt;dbl&gt; 2.0, 2.0, 0.0, 1.5, 0.0, 1.5, 0.0, 1.5, 2.0, 0.0, ...</span>
<span class="co">#&gt; $ OneNation   &lt;dbl&gt; 1.0, 1.0, 0.0, 1.0, 0.0, 1.5, 0.0, 1.0, 1.0, 0.0, ...</span>
<span class="co">#&gt; $ DK          &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</span>
<span class="co">#&gt; $ sampleSize  &lt;dbl&gt; 1451, 2090, 1150, 1451, 1130, 2136, 1132, 2010, 14...</span>
<span class="co">#&gt; $ org         &lt;fctr&gt; Morgan, F2F, Morgan, F2F, Newspoll, Morgan, F2F, ...</span>
<span class="co">#&gt; $ startDate   &lt;date&gt; 2004-10-30, 2004-11-13, 2004-11-19, 2004-11-27, 2...</span>
<span class="co">#&gt; $ endDate     &lt;date&gt; 2004-11-07, 2004-11-21, 2004-11-21, 2004-12-05, 2...</span>
<span class="co">#&gt; $ source      &lt;chr&gt; &quot;&quot;, &quot;http://www.roymorgan.com/news/polls/2004/3808...</span>
<span class="co">#&gt; $ remark      &lt;chr&gt; &quot;&quot;, &quot;face-to-face&quot;, &quot;&quot;, &quot;face-to-face&quot;, &quot;&quot;, &quot;face-...</span></code></pre></div>
<p>We will estimate the the proportion of the population that will vote the Australian Labor Party (ALP) in a House of Representatives election for each day between the elections. We model this as</p>
<p><span class="math display">\[
\begin{aligned}[t]
y_{j,t} &amp;= \delta_{j} + \xi_t + \varepsilon_{j,t} &amp; \varepsilon_{j,t} &amp; \sim N\left(0, \frac{y_{j,t} (1 - y_{j,t})}{r_{j,t}} \right) \\
\xi_t &amp; \xi_{t - 1} + \omega_t &amp; \omega_{t} &amp; \sim N(0, \sigma_{\omega})
\end{aligned}
\]</span> The observation variances are treated as known, and derived from the sample size and results of the poll. Jackman 2012 (p.475) puts a prior on the state variance to ensure that the daily changes in thestate are not too large, with a 95% interval of <span class="math inline">\(\pm 2%\)</span>, implying <span class="math inline">\(\sigma_{\omega} = 0.01\)</span>.</p>
<p>Polls have between 500 to 2,600 respondents, with a median of 1,156. While most of the polls use complex survey methods such as post-stratification weights to adjust for non-response, for the purposes of this analysis we will use the stated sample size of the poll as its effective size, and use that to construct the measurement error. There are 1,142 days in the period under consideration.</p>
<p>The unique polling firms and number of polls are,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AustralianElectionPolling %&gt;%<span class="st"> </span><span class="kw">group_by</span>(org) %&gt;%<span class="st"> </span><span class="kw">tally</span>()
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;             org     n</span>
<span class="co">#&gt;          &lt;fctr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1        Galaxy    10</span>
<span class="co">#&gt; 2   Morgan, F2F    94</span>
<span class="co">#&gt; 3      Newspoll    78</span>
<span class="co">#&gt; 4       Nielsen    42</span>
<span class="co">#&gt; 5 Morgan, Phone    15</span></code></pre></div>
<p>The face-to-face and phone polls by Morgan are treated separately. Each polling firm will be given its own house effect term to allow them to be systematically biased. However, we will require that the average of the house effects is zero; meaning that while each polling firm may be biased, on average they are not. <span class="math display">\[
\delta_j \sim N(0, d)
\]</span> Jackman uses a fixed value of <span class="math inline">\(d\)</span> that gives a 95% interval spanning from -0.15 to .15. This corresponds to <span class="math inline">\(d = 0.075\)</span>.</p>
<p>In the 2004 election the Australian Labor Party (ALP) won 37.6% percent of first preferences, and in 2007 they won 43.4%. These will be treated as coming from a source with no house effect and an infinitely large sample size.</p>
<pre class="raustralianelectionpolling"><code>library(&quot;dplyr&quot;)
data(&quot;AustralianElectionPolling&quot;, package = &quot;pscl&quot;)
glimpse(AustralianElectionPolling)</code></pre>
<p>Unique polling organizations (Morgan face-to-face and phone polls treated separately):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AustralianElectionPolling %&gt;%<span class="st"> </span><span class="kw">group_by</span>(org) %&gt;%<span class="st"> </span><span class="kw">tally</span>()
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;             org     n</span>
<span class="co">#&gt;          &lt;fctr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1        Galaxy    10</span>
<span class="co">#&gt; 2   Morgan, F2F    94</span>
<span class="co">#&gt; 3      Newspoll    78</span>
<span class="co">#&gt; 4       Nielsen    42</span>
<span class="co">#&gt; 5 Morgan, Phone    15</span></code></pre></div>
<p>Date of the poll is the median day (rounded down) for when they are in the field.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus_elections &lt;-
<span class="st">  </span><span class="kw">bind_rows</span>(
    <span class="kw">data_frame</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(<span class="st">&quot;2004-10-09&quot;</span>), <span class="dt">ALP =</span> <span class="fl">37.6</span>, <span class="dt">sd =</span> .<span class="dv">00025</span>),
    <span class="kw">data_frame</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(<span class="st">&quot;2007-11-24&quot;</span>), <span class="dt">ALP =</span> <span class="fl">43.4</span>, <span class="dt">sd =</span> .<span class="dv">00025</span>)
  )

aus_polling &lt;-
<span class="st">  </span>AustralianElectionPolling %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(org, startDate, endDate) %&gt;%
<span class="st">  </span><span class="co"># There are two Nielson polls on 2007-11-19 to 21.</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">ALP =</span> <span class="kw">weighted.mean</span>(ALP, sampleSize),
            <span class="dt">sampleSize =</span> <span class="kw">sum</span>(sampleSize)) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">floor_date</span>(<span class="kw">as.Date</span>(startDate) +<span class="st"> </span><span class="kw">difftime</span>(endDate, startDate, <span class="dt">unit =</span> <span class="st">&quot;days&quot;</span>), <span class="dt">unit =</span> <span class="st">&quot;day&quot;</span>),
         <span class="dt">y =</span> ALP /<span class="st"> </span><span class="dv">100</span>,
         <span class="dt">sd =</span> <span class="kw">sqrt</span>(y *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>y) /<span class="st"> </span>sampleSize),
         <span class="dt">org =</span> <span class="kw">as.character</span>(org)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(date, org, y, sd) %&gt;%
<span class="st">  </span><span class="kw">bind_rows</span>(<span class="kw">select</span>(<span class="kw">mutate</span>(aus_elections, <span class="dt">y =</span> ALP /<span class="st"> </span><span class="dv">100</span>, <span class="dt">org =</span> <span class="st">&quot;Election&quot;</span>), -ALP)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time =</span> <span class="kw">as.integer</span>(<span class="kw">difftime</span>(date, <span class="kw">as.Date</span>(<span class="st">&quot;2004-10-09&quot;</span>), <span class="dt">unit =</span> <span class="st">&quot;days&quot;</span>)) +<span class="st"> </span><span class="dv">1</span>)

datelist &lt;-
<span class="st">  </span><span class="kw">data_frame</span>(<span class="dt">date =</span> <span class="kw">seq</span>(<span class="kw">min</span>(aus_polling[[<span class="st">&quot;date&quot;</span>]]), <span class="kw">max</span>(aus_polling[[<span class="st">&quot;date&quot;</span>]]), <span class="dt">by =</span> <span class="st">&quot;days&quot;</span>),
             <span class="dt">time =</span> <span class="kw">min</span>(aus_polling[[<span class="st">&quot;time&quot;</span>]]):<span class="kw">max</span>(aus_polling[[<span class="st">&quot;time&quot;</span>]]))

polling_values &lt;-
<span class="st">  </span>aus_polling %&gt;%
<span class="st">  </span><span class="kw">select</span>(date, time, org, y) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(org, y) %&gt;%
<span class="st">  </span><span class="kw">full_join</span>(<span class="kw">select</span>(datelist, date), <span class="dt">by =</span> <span class="st">&quot;date&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(date) %&gt;%
<span class="st">  </span><span class="kw">select</span>(-time)

polling_sd &lt;-
<span class="st">  </span>aus_polling %&gt;%
<span class="st">  </span><span class="kw">select</span>(date, time, org, sd) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(org, sd) %&gt;%
<span class="st">  </span><span class="kw">full_join</span>(<span class="kw">select</span>(datelist, date), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;date&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(date) %&gt;%<span class="st">  </span>
<span class="st">  </span><span class="kw">select</span>(-time)


aus_elec_data &lt;-
<span class="st">  </span><span class="kw">within</span>(<span class="kw">list</span>(), {
    y &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">select</span>(polling_values, -date))
    missing &lt;-<span class="st"> </span><span class="kw">ssm_process_na</span>(y)
    p_t &lt;-<span class="st"> </span>missing$n
    y_idx &lt;-<span class="st"> </span>missing$idx
    <span class="kw">rm</span>(missing)
    y[<span class="kw">is.na</span>(y)] &lt;-<span class="st"> </span><span class="dv">0</span>
    n &lt;-<span class="st"> </span><span class="kw">nrow</span>(y)
    p &lt;-<span class="st"> </span><span class="kw">ncol</span>(y)
    sigma_eps &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">select</span>(polling_sd, -date)) %&gt;%
<span class="st">      </span><span class="kw">apply</span>(<span class="dv">2</span>, function(.) <span class="kw">if_else</span>(<span class="kw">is.na</span>(.), <span class="kw">median</span>(., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), .))
    sigma_delta &lt;-<span class="st"> </span>.<span class="dv">0075</span> <span class="co"># prior on house effects. p. 479. Jackman text.</span>
    zeta &lt;-<span class="st"> </span><span class="fl">0.1</span>
    a1 &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="fl">0.5</span>)
    P1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="fl">0.25</span>, <span class="dv">1</span>, <span class="dv">1</span>)
  })</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polling_mod &lt;-<span class="st"> </span><span class="kw">ssm_stan_model</span>(<span class="st">&quot;polling.stan&quot;</span>)
<span class="co">#&gt; In file included from filee49614c5cd4f.cpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/src/stan/model/model_header.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/mat.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core.hpp:42:</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core/set_zero_all_adjoints.hpp:14:17: warning: unused function &#39;set_zero_all_adjoints&#39; [-Wunused-function]</span>
<span class="co">#&gt;     static void set_zero_all_adjoints() {</span>
<span class="co">#&gt;                 ^</span>
<span class="co">#&gt; In file included from filee49614c5cd4f.cpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/src/stan/model/model_header.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/mat.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core.hpp:43:</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core/set_zero_all_adjoints_nested.hpp:17:17: warning: &#39;static&#39; function &#39;set_zero_all_adjoints_nested&#39; declared in header file should be declared &#39;static inline&#39; [-Wunneeded-internal-declaration]</span>
<span class="co">#&gt;     static void set_zero_all_adjoints_nested() {</span>
<span class="co">#&gt;                 ^</span>
<span class="co">#&gt; In file included from filee49614c5cd4f.cpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/src/stan/model/model_header.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/mat.hpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/mat.hpp:55:</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/mat/fun/autocorrelation.hpp:19:14: warning: function &#39;fft_next_good_size&#39; is not needed and will not be emitted [-Wunneeded-internal-declaration]</span>
<span class="co">#&gt;       size_t fft_next_good_size(size_t N) {</span>
<span class="co">#&gt;              ^</span>
<span class="co">#&gt; In file included from filee49614c5cd4f.cpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/src/stan/model/model_header.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/mat.hpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/mat.hpp:36:</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/mat/err/check_positive_ordered.hpp:39:67: warning: unused typedef &#39;size_type&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;       typedef typename index_type&lt;Matrix&lt;T_y, Dynamic, 1&gt; &gt;::type size_type;</span>
<span class="co">#&gt;                                                                   ^</span>
<span class="co">#&gt; In file included from filee49614c5cd4f.cpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/src/stan/model/model_header.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math.hpp:4:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/mat.hpp:8:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/mat.hpp:232:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/arr.hpp:33:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/prim/arr/functor/integrate_ode_rk45.hpp:13:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/numeric/odeint.hpp:61:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/numeric/odeint/util/multi_array_adaption.hpp:29:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/multi_array.hpp:21:</span>
<span class="co">#&gt; In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/multi_array/base.hpp:28:</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/multi_array/concept_checks.hpp:42:43: warning: unused typedef &#39;index_range&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;       typedef typename Array::index_range index_range;</span>
<span class="co">#&gt;                                           ^</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/multi_array/concept_checks.hpp:43:37: warning: unused typedef &#39;index&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;       typedef typename Array::index index;</span>
<span class="co">#&gt;                                     ^</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/multi_array/concept_checks.hpp:53:43: warning: unused typedef &#39;index_range&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;       typedef typename Array::index_range index_range;</span>
<span class="co">#&gt;                                           ^</span>
<span class="co">#&gt; /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/multi_array/concept_checks.hpp:54:37: warning: unused typedef &#39;index&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;       typedef typename Array::index index;</span>
<span class="co">#&gt;                                     ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:166:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:204:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:633:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:674:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:716:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:765:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:1651:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:1706:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:2446:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:3498:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:3757:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:4021:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:4502:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; filee49614c5cd4f.cpp:4555:20: warning: unused typedef &#39;fun_scalar_t__&#39; [-Wunused-local-typedef]</span>
<span class="co">#&gt;     typedef double fun_scalar_t__;</span>
<span class="co">#&gt;                    ^</span>
<span class="co">#&gt; 22 warnings generated.</span>
polling_samples &lt;-
<span class="st">  </span><span class="kw">sampling</span>(polling_mod, <span class="dt">data =</span> aus_elec_data, <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">chains =</span> <span class="dv">1</span>,
           <span class="dt">init =</span> <span class="kw">list</span>(<span class="kw">list</span>(<span class="dt">delta =</span> <span class="kw">rep</span>(<span class="dv">0</span>, aus_elec_data[[<span class="st">&quot;p&quot;</span>]] -<span class="st"> </span><span class="dv">1</span>),
                            <span class="dt">sigma_eta =</span> <span class="fl">0.005</span>,
                            <span class="dt">labmda =</span> <span class="kw">rep</span>(<span class="dv">1</span> /<span class="st"> </span>aus_elec_data[[<span class="st">&quot;n&quot;</span>]], aus_elec_data[[<span class="st">&quot;n&quot;</span>]]))))
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL &#39;polling&#39; NOW (CHAIN 1).</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Chain 1, Iteration:    1 / 2000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration:  200 / 2000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration:  400 / 2000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration:  600 / 2000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration:  800 / 2000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 1000 / 2000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1, Iteration: 1001 / 2000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 1200 / 2000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 1400 / 2000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 1600 / 2000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 1800 / 2000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 1, Iteration: 2000 / 2000 [100%]  (Sampling)</span>
<span class="co">#&gt;  Elapsed Time: 211.938 seconds (Warm-up)</span>
<span class="co">#&gt;                167.657 seconds (Sampling)</span>
<span class="co">#&gt;                379.595 seconds (Total)</span>
polling_summary &lt;-<span class="st"> </span><span class="kw">tidy_stan_summary</span>(<span class="kw">summary</span>(polling_samples))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(aus_polling, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> y,
                        <span class="dt">ymin =</span> y -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
                        <span class="dt">ymax =</span> y +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd,
                        <span class="dt">colour =</span> org)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>() +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-AustralianElectionPolling_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polling_samples &lt;-<span class="st"> </span>polling_summary[[<span class="st">&quot;all&quot;</span>]] %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(datelist, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;dim_1&quot;</span> =<span class="st"> &quot;time&quot;</span>))

<span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> <span class="kw">filter</span>(polling_samples, parameter ==<span class="st"> &quot;alpha&quot;</span>),
              <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">ymin =</span> mean -<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd, <span class="dt">ymax =</span> mean +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>sd), <span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> <span class="kw">filter</span>(polling_samples, parameter ==<span class="st"> &quot;alpha&quot;</span>),
            <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> mean)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> aus_polling, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> y, <span class="dt">colour =</span> org)) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="example-AustralianElectionPolling_files/figure-html/capm-state-plot-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(polling_summary[[<span class="st">&quot;all&quot;</span>]], parameter ==<span class="st"> &quot;delta&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(parname, mean, se_mean, p2<span class="fl">.5</span>, p97<span class="fl">.5</span>, n_eff, Rhat)
<span class="co">#&gt; # A tibble: 5 x 7</span>
<span class="co">#&gt;    parname      mean  se_mean     p2.5    p97.5 n_eff  Rhat</span>
<span class="co">#&gt;      &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 delta[1] -0.013136 0.000181 -0.02256 -0.00477   690 1.000</span>
<span class="co">#&gt; 2 delta[2]  0.018446 0.000179  0.01123  0.02576   425 1.001</span>
<span class="co">#&gt; 3 delta[3]  0.000314 0.000199 -0.00841  0.00898   506 1.000</span>
<span class="co">#&gt; 4 delta[4]  0.004033 0.000169 -0.00323  0.01107   462 0.999</span>
<span class="co">#&gt; 5 delta[5]  0.002159 0.000173 -0.00521  0.00938   480 1.000</span></code></pre></div>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-DurbinKoopman2012">
<p>Durbin, J., and S.J. Koopman. 2012. <em>Time Series Analysis by State Space Methods: Second Edition</em>. Oxford Statistical Science Series. OUP Oxford. <a href="http://books.google.com/books?id=fOq39Zh0olQC" class="uri">http://books.google.com/books?id=fOq39Zh0olQC</a>.</p>
</div>
<div id="ref-Cobb1978">
<p>Cobb, George W. 1978. The Problem of the Nile: Conditional Solution to a Changepoint Problem. <em>Biometrika</em> 65 (2): 24351. doi:<a href="https://doi.org/10.1093/biomet/65.2.243">10.1093/biomet/65.2.243</a>.</p>
</div>
<div id="ref-Balke1993">
<p>Balke, Nathan S. 1993. Detecting Level Shifts in Time Series. <em>Journal of Business &amp; Economic Statistics</em> 11 (1). American Statistical Association: 8192. <a href="http://www.jstor.org/stable/1391308" class="uri">http://www.jstor.org/stable/1391308</a>.</p>
</div>
<div id="ref-Petris2010a">
<p>Petris, Giovanni. 2010. An R Package for Dynamic Linear Models. <em>Journal of Statistical Software</em> 36 (12): 116. <a href="http://www.jstatsoft.org/v36/i12/" class="uri">http://www.jstatsoft.org/v36/i12/</a>.</p>
</div>
<div id="ref-Berndt1991a">
<p>Berndt, Ernst R. 1991. <em>The Practice of Econometrics: Classic and Commentary</em>. Addison-Wesley.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="example-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="stan-functions.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jrnold/ssmodels-in-stan/edit/master/example-Nile.Rmd",
"text": "Edit"
},
"download": ["ssmodels-in-stan.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
